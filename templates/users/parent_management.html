{% extends 'base.html' %}

{% block title %}Parent Management - School Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Parent Management</h1>
        <div class="btn-group">
            <a href="{% url 'users:register_parent' %}" class="btn btn-primary">
                <i class="fas fa-user-plus me-2"></i>Add New Parent
            </a>
            <a href="{% url 'users:csv_upload_page' %}" class="btn btn-success">
                <i class="fas fa-file-csv me-2"></i>Bulk Import CSV
            </a>
            <a href="{% url 'users:export_parents' 'csv' %}" class="btn btn-outline-secondary">
                <i class="fas fa-file-csv me-2"></i>Export CSV
            </a>
            <a href="{% url 'users:export_parents' 'excel' %}" class="btn btn-outline-success">
                <i class="fas fa-file-excel me-2"></i>Export Excel
            </a>
            <button id="btnResendSelected" type="button" class="btn btn-warning" onclick="resendWelcomeEmailSelected()">
                <i class="fas fa-envelope-open-text me-2"></i>Resend Selected
            </button>
            <button id="btnResendAll" type="button" class="btn btn-danger" onclick="resendWelcomeEmailAll()">
                <i class="fas fa-paper-plane me-2"></i>Resend To All
            </button>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Filter Parents</h6>
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="true" aria-controls="filterCollapse">
                <i class="fas fa-sliders-h me-1"></i> Toggle Filters
            </button>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body bg-light py-3">
                <form method="get" class="mb-0">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-4">
                            <label for="searchQuery" class="form-label small fw-bold">Search Parents</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fas fa-search text-primary"></i></span>
                                <input type="text" class="form-control" id="searchQuery" name="search" 
                                       placeholder="Name, email, phone..." 
                                       value="{{ search_query|default:'' }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="relationshipFilter" class="form-label small fw-bold">Relationship</label>
                            <select class="form-select" id="relationshipFilter" name="relationship">
                                <option value="" {% if not relationship_filter %}selected{% endif %}>All Relationships</option>
                                <option value="Parent" {% if relationship_filter == 'Parent' %}selected{% endif %}>Parent</option>
                                <option value="Guardian" {% if relationship_filter == 'Guardian' %}selected{% endif %}>Guardian</option>
                                <option value="Other" {% if relationship_filter == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label small fw-bold">Status</label>
                            <select class="form-select" id="statusFilter" name="status">
                                <option value="" {% if not status_filter %}selected{% endif %}>All Status</option>
                                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Parents Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Parent Directory</h6>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary">{{ parents|length }} Parents</span>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btnResendSelected" title="Resend Welcome to Selected" onclick="resendWelcomeEmailSelected()">
                    <i class="fas fa-paper-plane me-1"></i>Resend Selected
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="btnResendAll" title="Resend Welcome to All" onclick="resendWelcomeEmailAll()">
                    <i class="fas fa-bullhorn me-1"></i>Resend To All
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if parents %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="parentsTable">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th style="width: 36px;" class="text-center">
                                    <input type="checkbox" id="selectAllParents" onclick="toggleSelectAll(this)">
                                </th>
                                <th style="width: 250px;">Name</th>
                                <th style="width: 120px;">Relationship</th>
                                <th>Children</th>
                                <th>Email</th>
                                <th style="width: 100px;">Status</th>
                                <th style="width: 150px;" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for parent in parents %}
                                <tr>
                                    <td class="text-center">
                                        <input type="checkbox" class="parent-select" value="{{ parent.user.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if parent.user.profile_picture %}
                                                <img src="{{ parent.user.profile_picture.url }}" alt="{{ parent.user.get_full_name }}" 
                                                     class="rounded-circle me-3 border shadow-sm" width="45" height="45">
                                            {% else %}
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm"
                                                     style="width: 45px; height: 45px;">
                                                    <span class="fw-bold">{{ parent.user.first_name|first }}{{ parent.user.last_name|first }}</span>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold text-primary">
                                                    <a href="{% url 'users:parent_detail' parent.id %}" class="text-primary text-decoration-none">
                                                        {{ parent.user.get_full_name }}
                                                    </a>
                                                </div>
                                                <div class="text-muted small">
                                                    <i class="fas fa-phone-alt me-1 text-secondary"></i>{{ parent.user.phone_number|default:"No phone" }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-info text-white">{{ parent.relationship }}</span></td>
                                    <td>
                                        {% if parent.children.all %}
                                            <div class="d-flex flex-column">
                                                {% for child in parent.children.all|slice:":2" %}
                                                    <div class="d-flex align-items-center mb-1">
                                                        <span class="badge bg-primary rounded-circle me-1 d-flex align-items-center justify-content-center" style="width: 25px; height: 25px;">
                                                            {{ child.user.first_name|first }}
                                                        </span>
                                                        <span>{{ child.user.get_full_name }}</span>
                                                    </div>
                                                {% endfor %}
                                                {% if parent.children.count > 2 %}
                                                    <div class="small text-primary mt-1">
                                                        <i class="fas fa-plus-circle me-1"></i>{{ parent.children.count|add:"-2" }} more children
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <div class="text-center">
                                                <span class="badge bg-secondary py-2 px-3">No children linked</span>
                                                <div class="small mt-1">
                                                    <a href="{% url 'users:link_parent_to_child' %}?parent_id={{ parent.id }}" class="text-primary">
                                                        <i class="fas fa-link me-1"></i>Link now
                                                    </a>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-envelope text-muted me-2"></i>
                                            <a href="mailto:{{ parent.user.email }}" class="text-decoration-none text-truncate">{{ parent.user.email }}</a>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if parent.user.is_active and parent.user.is_verified %}
                                            <span class="badge bg-success px-3 py-2">Active</span>
                                        {% elif parent.user.is_active and not parent.user.is_verified %}
                                            <span class="badge bg-warning px-3 py-2">Unverified</span>
                                        {% else %}
                                            <span class="badge bg-secondary px-3 py-2">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex justify-content-center">
                                            <a href="{% url 'users:edit_user' parent.user.id %}" class="btn btn-sm btn-primary me-1" title="Edit Parent">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'users:parent_detail' parent.id %}" class="btn btn-sm btn-success me-1" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'users:link_parent_to_child' %}?parent_id={{ parent.id }}" class="btn btn-sm btn-info me-1" title="Link to Child">
                                                <i class="fas fa-child"></i>
                                            </a>
                                            {% if parent.user.id != request.user.id %}
                                                <a href="{% url 'users:delete_user' parent.user.id %}" class="btn btn-sm btn-danger" title="Delete Parent">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-users fa-3x text-muted"></i>
                    </div>
                    <h5 class="text-muted">No parents found</h5>
                    <p class="text-muted">
                        {% if relationship_filter or search_query %}
                            No parents match your current filters. Try adjusting your search criteria.
                        {% else %}
                            There are no parents in the system yet. Start by adding a new parent.
                        {% endif %}
                    </p>
                    <a href="{% url 'users:register_parent' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-user-plus me-2"></i>Add New Parent
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Parent Management Actions</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <a href="{% url 'users:register_parent' %}" class="card h-100 border-left-primary text-decoration-none">
                        <div class="card-body">
                            <h5 class="card-title text-primary"><i class="fas fa-user-plus me-2"></i>Register Parent</h5>
                            <p class="card-text text-muted">Add a new parent to the system with all necessary information.</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <a href="{% url 'users:link_parent_to_child' %}" class="card h-100 border-left-success text-decoration-none">
                        <div class="card-body">
                            <h5 class="card-title text-success"><i class="fas fa-link me-2"></i>Link Children</h5>
                            <p class="card-text text-muted">Associate parents with their children for proper access and notifications.</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <a href="{% url 'users:student_management' %}" class="card h-100 border-left-info text-decoration-none">
                        <div class="card-body">
                            <h5 class="card-title text-info"><i class="fas fa-user-graduate me-2"></i>Manage Students</h5>
                            <p class="card-text text-muted">View and manage students and assign them to parents.</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <a href="{% url 'communications:compose_message' %}" class="card h-100 border-left-warning text-decoration-none">
                        <div class="card-body">
                            <h5 class="card-title text-warning"><i class="fas fa-envelope me-2"></i>Message Parents</h5>
                            <p class="card-text text-muted">Send communications to parents about school events or their children.</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // CSRF helper from Django docs
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function resendWelcomeEmail(userId, fullName) {
    const csrftoken = getCookie('csrftoken');
    const btns = document.querySelectorAll(`button[onclick*="resendWelcomeEmail('${userId}'"]`);
    btns.forEach(b => { b.disabled = true; b.dataset.originalHtml = b.innerHTML; b.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; });

    // Build URL by injecting the ID into a reversed placeholder URL
    const baseUrl = '{% url "users:resend_welcome_email" 0 %}';
    const url = baseUrl.replace('/0/', `/${userId}/`);

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({})
      });
      const data = await resp.json();
      if (data.success) {
        showToast('Success', data.message || `Welcome email sent to ${fullName}.`, 'bg-success');
      } else {
        showToast('Error', data.error || 'Failed to send welcome email.', 'bg-danger');
      }
    } catch (e) {
      showToast('Error', 'Network or server error while sending email.', 'bg-danger');
    } finally {
      btns.forEach(b => { b.disabled = false; b.innerHTML = b.dataset.originalHtml || '<i class="fas fa-envelope"></i>'; });
    }
  }

  function toggleSelectAll(master) {
    document.querySelectorAll('.parent-select').forEach(cb => cb.checked = master.checked);
  }

  function getSelectedParentIds() {
    return Array.from(document.querySelectorAll('.parent-select:checked')).map(cb => cb.value);
  }

  async function resendWelcomeEmailSelected() {
    const ids = getSelectedParentIds();
    if (!ids.length) {
      showToast('Info', 'No parents selected.', 'bg-info');
      return;
    }
    await resendWelcomeEmailBulk(ids);
  }

  async function resendWelcomeEmailBulk(userIds) {
    const csrftoken = getCookie('csrftoken');
    const url = '{% url "users:resend_welcome_email_bulk" %}';
    const btn = document.getElementById('btnResendSelected');
    if (btn) { btn.disabled = true; btn.dataset.originalHtml = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...'; }
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ user_ids: userIds })
      });
      const data = await resp.json();
      if (data.success) {
        showToast('Success', `Sent: ${data.sent} | Failed: ${data.failed}`, 'bg-success');
      } else {
        showToast('Error', data.error || 'Bulk send failed.', 'bg-danger');
      }
    } catch (e) {
      showToast('Error', 'Network or server error during bulk send.', 'bg-danger');
    } finally {
      if (btn) { btn.disabled = false; btn.innerHTML = btn.dataset.originalHtml || 'Resend Selected'; }
    }
  }

  async function resendWelcomeEmailAll() {
    if (!confirm('Resend welcome email to ALL parents? This may take a while.')) return;
    const csrftoken = getCookie('csrftoken');
    const url = '{% url "users:resend_welcome_email_all" %}';
    const btn = document.getElementById('btnResendAll');
    if (btn) { btn.disabled = true; btn.dataset.originalHtml = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...'; }
    try {
      const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify({}) });
      const data = await resp.json();
      if (data.success) {
        showToast('Success', `Sent: ${data.sent} | Failed: ${data.failed}`, 'bg-success');
      } else {
        showToast('Error', data.error || 'Send-to-all failed.', 'bg-danger');
      }
    } catch (e) {
      showToast('Error', 'Network or server error during send-to-all.', 'bg-danger');
    } finally {
      if (btn) { btn.disabled = false; btn.innerHTML = btn.dataset.originalHtml || 'Resend To All'; }
    }
  }

  function showToast(title, message, headerClass) {
    // Simple Bootstrap toast generator (requires Bootstrap 5)
    const containerId = 'toast-container';
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.className = 'position-fixed top-0 end-0 p-3';
      container.style.zIndex = 1080;
      document.body.appendChild(container);
    }

    const toastEl = document.createElement('div');
    toastEl.className = 'toast align-items-center text-white border-0 show';
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
      <div class="toast-header ${headerClass} text-white">
        <strong class="me-auto">${title}</strong>
        <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body text-dark bg-white">${message}</div>
    `;
    container.appendChild(toastEl);
    setTimeout(() => { toastEl.remove(); }, 5000);
  }
  // Improve modal focus to prevent flicker/blink from focus bounce
  document.addEventListener('DOMContentLoaded', function () {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(m => {
      m.addEventListener('shown.bs.modal', (e) => {
        const closeBtn = e.target.querySelector('.btn-close');
        if (closeBtn) closeBtn.focus();
      });
    });
  });
</script>
{% endblock %}
