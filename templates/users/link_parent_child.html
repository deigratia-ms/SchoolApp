{% extends 'base.html' %}

{% block title %}Link Parent to Child | Deigratia Montessori School{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Link Parent to Child</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'users:user_management' %}">User Management</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Link Parent to Child</li>
                </ol>
            </nav>
        </div>
        <a href="{% url 'users:user_management' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to User Management
        </a>
    </div>

    <div class="row">
        <!-- Current Parent-Child Associations -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Current Parent-Child Relationships</h6>
                </div>
                <div class="card-body">
                    <!-- Preselected (from query params) data holder to avoid inline Django in JS -->
                    <div id="prefillData"
                         data-parent-id="{{ preselected_parent.id|default:'' }}"
                         data-parent-name="{{ preselected_parent.user.get_full_name|default:''|escapejs }}"
                         data-student-id="{{ preselected_student.id|default:'' }}"
                         data-student-name="{{ preselected_student.user.get_full_name|default:''|escapejs }}"
                         data-student-sid="{{ preselected_student.student_id|default:'' }}"
                         style="display:none;"></div>
                    {% if parents %}
                    <div class="accordion" id="parentAccordion">
                        {% for parent in parents %}
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="heading{{ parent.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ parent.id }}" aria-expanded="false" aria-controls="collapse{{ parent.id }}">
                                    <span class="fw-bold">{{ parent.user.get_full_name }}</span>
                                    <span class="ms-2 badge bg-secondary">{{ parent.relationship }}</span>
                                </button>
                            </h2>
                            <div id="collapse{{ parent.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ parent.id }}" data-bs-parent="#parentAccordion">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Email: {{ parent.user.email }}</small>
                                    </div>
                                    
                                    {% if parent.children.all %}
                                    <div class="list-group">
                                        <div class="list-group-item active">
                                            <i class="fas fa-child me-2"></i>Children
                                        </div>
                                        {% for child in parent.children.all %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <span>{{ child.user.get_full_name }}</span>
                                                <small class="text-muted d-block">ID: {{ child.student_id }} | Grade: {{ child.grade }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>No children associated
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if parents_page %}
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">Page {{ parents_page.number }} of {{ parents_pages }} (Total {{ parents_count }})</small>
                        <div class="btn-group btn-group-sm" role="group">
                            {% if parents_page.has_previous %}
                            <a class="btn btn-outline-primary" href="?parent_page={{ parents_page.previous_page_number }}">Prev</a>
                            {% else %}
                            <a class="btn btn-outline-primary disabled" href="#" tabindex="-1" aria-disabled="true">Prev</a>
                            {% endif %}
                            {% if parents_page.has_next %}
                            <a class="btn btn-outline-primary" href="?parent_page={{ parents_page.next_page_number }}">Next</a>
                            {% else %}
                            <a class="btn btn-outline-primary disabled" href="#" tabindex="-1" aria-disabled="true">Next</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">No parents registered in the system.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Link Form -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Associate Parent with Children</h6>
                    <span class="badge bg-info" id="selectedCountBadge">0 selected</span>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label">Find Parent *</label>
                        <div class="input-group">
                            <input type="text" id="parentSearchInput" class="form-control" placeholder="Search by name, email or phone..." value="{% if preselected_parent %}{{ preselected_parent.user.get_full_name }}{% endif %}">
                            <button class="btn btn-outline-secondary" type="button" id="clearParentSearch"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="list-group mt-2" id="parentResults" style="max-height: 220px; overflow:auto;"></div>
                        <div class="mt-2" id="selectedParentWrap" {% if not preselected_parent %}style="display:none;"{% endif %}>
                            <span class="fw-bold">Selected Parent:</span>
                            <div class="alert alert-light border d-flex align-items-center mt-2 mb-0" id="selectedParentChip">
                                {% if preselected_parent %}
                                    <i class="fas fa-user text-primary me-2"></i>
                                    <span id="selectedParentName">{{ preselected_parent.user.get_full_name }}</span>
                                    <span class="text-muted ms-2">{{ preselected_parent.user.email }}</span>
                                    <button type="button" class="btn btn-sm btn-link text-danger ms-auto p-0" id="clearSelectedParent">Remove</button>
                                {% else %}
                                    <i class="fas fa-user text-primary me-2"></i>
                                    <span id="selectedParentName"></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <label class="form-label mb-0">Find Students *</label>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn" type="button">Select All (Page)</button>
                            <button class="btn btn-sm btn-outline-secondary" id="clearSelectionBtn" type="button">Clear Selection</button>
                        </div>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" id="studentSearchInput" class="form-control" placeholder="Search by name, student ID or email..." value="{% if preselected_student %}{{ preselected_student.user.get_full_name }}{% endif %}">
                        <button class="btn btn-outline-secondary" type="button" id="clearStudentSearch"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="studentResults" class="list-group" style="max-height: 280px; overflow:auto;"></div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted" id="studentPagingMeta"></small>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" id="prevStudentsPage" type="button">Prev</button>
                            <button class="btn btn-outline-primary" id="nextStudentsPage" type="button">Next</button>
                        </div>
                    </div>

                    <div class="mt-3" id="selectedStudentsChips"></div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            You can link multiple children to the same parent by repeating this process for each child.
                        </div>
                        
                        <div class="text-end">
                            <button class="btn btn-primary" id="linkNowBtn" type="button" disabled>
                                <i class="fas fa-link me-2"></i>Link Selected
                            </button>
                        </div>
                </div>
            </div>
            
            <!-- Quick Help -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Help</h6>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-question-circle text-info me-2"></i>About Parent-Child Linking</h6>
                    <ul class="small">
                        <li>Parents can be linked to multiple children.</li>
                        <li>Children can have multiple parents/guardians linked to them.</li>
                        <li>This relationship allows parents to view their children's academic records, grades, attendance, etc.</li>
                        <li>Linked parents will receive notifications about their children's academic activities.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const $parentSearchInput = document.getElementById('parentSearchInput');
        const $parentResults = document.getElementById('parentResults');
        const $selectedParentWrap = document.getElementById('selectedParentWrap');
        const $selectedParentName = document.getElementById('selectedParentName');
        const $clearSelectedParent = document.getElementById('clearSelectedParent');
        const $clearParentSearch = document.getElementById('clearParentSearch');

        const $studentSearchInput = document.getElementById('studentSearchInput');
        const $clearStudentSearch = document.getElementById('clearStudentSearch');
        const $studentResults = document.getElementById('studentResults');
        const $studentPagingMeta = document.getElementById('studentPagingMeta');
        const $prevStudentsPage = document.getElementById('prevStudentsPage');
        const $nextStudentsPage = document.getElementById('nextStudentsPage');
        const $selectedStudentsChips = document.getElementById('selectedStudentsChips');
        const $linkNowBtn = document.getElementById('linkNowBtn');
        const $selectedCountBadge = document.getElementById('selectedCountBadge');
        const $clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const $selectAllBtn = document.getElementById('selectAllBtn');

        let selectedParent = null;
        let selectedStudents = {};
        const $prefill = document.getElementById('prefillData');
        if ($prefill) {
            const pid = $prefill.dataset.parentId;
            const pname = $prefill.dataset.parentName;
            if (pid && pname) {
                selectedParent = { id: parseInt(pid), name: pname };
                $selectedParentWrap.style.display = '';
                $selectedParentName.textContent = pname;
            }
            const sid = $prefill.dataset.studentId;
            const sname = $prefill.dataset.studentName;
            const ssid = $prefill.dataset.studentSid;
            if (sid && sname) {
                selectedStudents[parseInt(sid)] = { id: parseInt(sid), name: sname, student_id: ssid || '' };
            }
        }

        let studentsPage = 1;
        let studentsPages = 1;
        let studentQuery = '';
        let typingTimer;

        function updateCounts() {
            const count = Object.keys(selectedStudents).length;
            $selectedCountBadge.textContent = count + ' selected';
            $linkNowBtn.disabled = !(selectedParent && count > 0);
        }

        function renderSelectedStudents() {
            $selectedStudentsChips.innerHTML = '';
            Object.values(selectedStudents).forEach(s => {
                const chip = document.createElement('span');
                chip.className = 'badge bg-secondary me-2 mb-2';
                chip.textContent = s.name + (s.student_id ? ' (' + s.student_id + ')' : '');
                const remove = document.createElement('button');
                remove.type = 'button';
                remove.className = 'btn btn-sm btn-link text-danger ms-2 p-0';
                remove.textContent = 'x';
                remove.onclick = () => { delete selectedStudents[s.id]; renderSelectedStudents(); updateCounts(); syncCheckboxes(); };
                const wrap = document.createElement('span');
                wrap.className = 'd-inline-flex align-items-center';
                wrap.appendChild(chip);
                wrap.appendChild(remove);
                $selectedStudentsChips.appendChild(wrap);
            });
        }

        function syncCheckboxes() {
            $studentResults.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const id = parseInt(cb.value);
                cb.checked = !!selectedStudents[id];
            });
        }

        function debounce(fn, delay) {
            return function(...args) {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function searchParents(q) {
            if (!q || q.length < 2) { $parentResults.innerHTML = ''; return; }
            fetch(`{% url 'users:api_search_parents' %}?q=${encodeURIComponent(q)}&page=1&page_size=10`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(r => r.json()).then(data => {
                $parentResults.innerHTML = '';
                data.results.forEach(p => {
                    const a = document.createElement('a');
                    a.href = 'javascript:void(0)';
                    a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    a.innerHTML = `<span><i class="fas fa-user text-primary me-2"></i>${p.name} <small class="text-muted">${p.email||''}</small></span>`;
                    a.onclick = () => {
                        selectedParent = { id: p.id, name: p.name };
                        $selectedParentWrap.style.display = '';
                        $selectedParentName.textContent = p.name;
                        $parentResults.innerHTML = '';
                        updateCounts();
                    };
                    $parentResults.appendChild(a);
                });
            });
        }

        function fetchStudents() {
            const q = studentQuery;
            fetch(`{% url 'users:api_search_students' %}?q=${encodeURIComponent(q)}&page=${studentsPage}&page_size=20`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(r => r.json()).then(data => {
                studentsPages = data.pages;
                $studentResults.innerHTML = '';
                data.results.forEach(s => {
                    const item = document.createElement('label');
                    item.className = 'list-group-item d-flex align-items-center';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'form-check-input me-2';
                    cb.value = s.id;
                    cb.onchange = () => {
                        if (cb.checked) {
                            selectedStudents[s.id] = { id: s.id, name: s.name, student_id: s.student_id };
                        } else {
                            delete selectedStudents[s.id];
                        }
                        renderSelectedStudents();
                        updateCounts();
                    };
                    const body = document.createElement('div');
                    body.innerHTML = `<div class="fw-bold">${s.name}</div><div class="small text-muted">ID: ${s.student_id||''} ${s.grade?('| Grade '+s.grade):''} ${s.section?('- '+s.section):''}</div>`;
                    item.appendChild(cb);
                    item.appendChild(body);
                    $studentResults.appendChild(item);
                });
                syncCheckboxes();
                $studentPagingMeta.textContent = `Page ${data.page} of ${data.pages} (Total ${data.count})`;
                $prevStudentsPage.disabled = data.page <= 1;
                $nextStudentsPage.disabled = data.page >= data.pages;
            });
        }

        // Events
        $parentSearchInput && $parentSearchInput.addEventListener('input', debounce(function(e){
            searchParents(e.target.value.trim());
        }, 250));
        $clearParentSearch && $clearParentSearch.addEventListener('click', function(){
            $parentSearchInput.value = '';
            $parentResults.innerHTML = '';
        });
        $clearSelectedParent && $clearSelectedParent.addEventListener('click', function(){
            selectedParent = null;
            $selectedParentWrap.style.display = 'none';
            updateCounts();
        });

        $studentSearchInput && $studentSearchInput.addEventListener('input', debounce(function(e){
            studentQuery = e.target.value.trim();
            studentsPage = 1;
            fetchStudents();
        }, 250));
        $clearStudentSearch && $clearStudentSearch.addEventListener('click', function(){
            $studentSearchInput.value = '';
            studentQuery = '';
            studentsPage = 1;
            fetchStudents();
        });
        $prevStudentsPage && $prevStudentsPage.addEventListener('click', function(){ if (studentsPage>1){ studentsPage--; fetchStudents(); }});
        $nextStudentsPage && $nextStudentsPage.addEventListener('click', function(){ if (studentsPage<studentsPages){ studentsPage++; fetchStudents(); }});
        $clearSelectionBtn && $clearSelectionBtn.addEventListener('click', function(){ selectedStudents = {}; renderSelectedStudents(); updateCounts(); syncCheckboxes(); });
        $selectAllBtn && $selectAllBtn.addEventListener('click', function(){
            $studentResults.querySelectorAll('input[type="checkbox"]').forEach(cb => { if (!cb.checked) cb.click(); });
        });

        $linkNowBtn && $linkNowBtn.addEventListener('click', function(){
            if (!selectedParent) { alert('Please select a parent'); return; }
            const ids = Object.keys(selectedStudents).map(x => parseInt(x));
            if (!ids.length) { alert('Please select at least one student'); return; }
            $linkNowBtn.disabled = true;
            fetch(`{% url 'users:link_parent_to_child' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ parent_id: selectedParent.id, student_ids: ids })
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    alert(`Linked ${data.linked_count} student(s) to ${data.parent.name}`);
                    // Keep selection but allow more linking
                } else {
                    alert(data.error || 'Failed to link');
                }
            }).catch(err => {
                alert('Error: ' + err);
            }).finally(() => { $linkNowBtn.disabled = false; });
        });

        // Initial
        fetchStudents();
        renderSelectedStudents();
        updateCounts();
    })();
</script>
{% endblock %}