{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Time Slots - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .time-slot-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .time-slot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .time-slot-card.available {
        border-left: 4px solid #28a745;
    }
    .time-slot-card.unavailable {
        border-left: 4px solid #dc3545;
    }
    .time-slot-card.inactive {
        border-left: 4px solid #6c757d;
        opacity: 0.7;
    }
    .time-slot-card.selected {
        background-color: #e9f7fe;
        border: 2px solid #0d6efd;
    }
    .date-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-weight: 600;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .checkbox-container {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'appointments:admin_dashboard' %}">Appointment Administration</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Manage Time Slots</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Manage Time Slots</h5>
                    <div>
                        <a href="{% url 'appointments:manage_settings' %}" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-cog me-1"></i> Settings
                        </a>
                        <a href="{% url 'appointments:generate_time_slots' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-calendar-plus me-1"></i> Generate Slots
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <p>View and manage available time slots for appointments. You can select multiple slots to delete or deactivate them.</p>

                    <div class="filter-section mb-4">
                        <form method="get" id="filterForm">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="date_from" class="form-label">Date From</label>
                                    <input type="date" id="date_from" name="date_from" class="form-control" value="{{ request.GET.date_from }}">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="date_to" class="form-label">Date To</label>
                                    <input type="date" id="date_to" name="date_to" class="form-control" value="{{ request.GET.date_to }}">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select id="status" name="status" class="form-select">
                                        <option value="">All Statuses</option>
                                        <option value="available" {% if request.GET.status == 'available' %}selected{% endif %}>Available</option>
                                        <option value="unavailable" {% if request.GET.status == 'unavailable' %}selected{% endif %}>Booked</option>
                                        <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="time" class="form-label">Time</label>
                                    <input type="time" id="time" name="time" class="form-control" value="{{ request.GET.time }}">
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter me-1"></i> Apply Filters
                                </button>
                                <a href="{% url 'appointments:manage_time_slots' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Clear Filters
                                </a>
                            </div>
                        </form>
                    </div>

                    <div class="bulk-actions mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button id="selectAllBtn" class="btn btn-outline-primary btn-sm me-2">
                                    <i class="fas fa-check-square me-1"></i> Select All
                                </button>
                                <button id="deselectAllBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-square me-1"></i> Deselect All
                                </button>
                            </div>
                            <div>
                                <button id="deleteSelectedBtn" class="btn btn-danger btn-sm me-2" disabled>
                                    <i class="fas fa-trash me-1"></i> Delete Selected
                                </button>
                                <button id="deactivateSelectedBtn" class="btn btn-warning btn-sm me-2" disabled>
                                    <i class="fas fa-power-off me-1"></i> Deactivate Selected
                                </button>
                                <button id="activateSelectedBtn" class="btn btn-success btn-sm" disabled>
                                    <i class="fas fa-check-circle me-1"></i> Activate Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="bulkActionForm" method="post" action="{% url 'appointments:bulk_time_slot_action' %}">
        {% csrf_token %}
        <input type="hidden" name="action" id="bulkAction" value="">
        <input type="hidden" name="slot_ids" id="selectedSlotIds" value="">

        {% if time_slots %}
            {% regroup time_slots by date as date_list %}

            {% for date_group in date_list %}
                <div class="date-header">
                    <i class="fas fa-calendar-day me-2"></i> {{ date_group.grouper|date:"l, F d, Y" }}
                </div>

                <div class="row mb-4">
                    {% for slot in date_group.list %}
                        <div class="col-md-3 mb-3">
                            <div class="card time-slot-card {% if not slot.is_active %}inactive{% elif slot.is_available %}available{% else %}unavailable{% endif %}" data-slot-id="{{ slot.id }}">
                                <div class="checkbox-container">
                                    <input type="checkbox" class="form-check-input slot-checkbox" data-slot-id="{{ slot.id }}" {% if not slot.is_available %}disabled{% endif %}>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">
                                            {{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}
                                        </h6>
                                        <span class="badge {% if not slot.is_active %}bg-secondary{% elif slot.is_available %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if not slot.is_active %}Inactive{% elif slot.is_available %}Available{% else %}Booked{% endif %}
                                        </span>
                                    </div>

                                    {% if slot.is_available and slot.is_active %}
                                        <div class="d-flex justify-content-end mt-3">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-slot" data-slot-id="{{ slot.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning deactivate-slot" data-slot-id="{{ slot.id }}">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% elif not slot.is_active %}
                                        <div class="d-flex justify-content-end mt-3">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-slot" data-slot-id="{{ slot.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success activate-slot" data-slot-id="{{ slot.id }}">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% else %}
                                        {% for appointment in slot.appointment_set.all %}
                                            <p class="small mb-1">
                                                <strong>Parent:</strong> {{ appointment.parent.user.get_full_name }}
                                            </p>
                                            <p class="small mb-0">
                                                <strong>Status:</strong>
                                                <span class="text-{% if appointment.status == 'confirmed' %}success{% elif appointment.status == 'pending' %}warning{% elif appointment.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                                    {{ appointment.get_status_display }}
                                                </span>
                                            </p>
                                            <div class="d-flex justify-content-end mt-2">
                                                <a href="{% url 'appointments:appointment_detail' appointment.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> No time slots found. Use the "Generate Slots" button to create new time slots.
            </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Card selection
        const timeSlotCards = document.querySelectorAll('.time-slot-card');
        const slotCheckboxes = document.querySelectorAll('.slot-checkbox');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deactivateSelectedBtn = document.getElementById('deactivateSelectedBtn');
        const activateSelectedBtn = document.getElementById('activateSelectedBtn');
        const bulkActionForm = document.getElementById('bulkActionForm');
        const bulkAction = document.getElementById('bulkAction');
        const selectedSlotIds = document.getElementById('selectedSlotIds');

        // Individual delete buttons
        const deleteButtons = document.querySelectorAll('.delete-slot');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this time slot?')) {
                    const slotId = this.dataset.slotId;
                    bulkAction.value = 'delete';
                    selectedSlotIds.value = slotId;
                    bulkActionForm.submit();
                }
            });
        });

        // Individual deactivate buttons
        const deactivateButtons = document.querySelectorAll('.deactivate-slot');
        deactivateButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to deactivate this time slot?')) {
                    const slotId = this.dataset.slotId;
                    bulkAction.value = 'deactivate';
                    selectedSlotIds.value = slotId;
                    bulkActionForm.submit();
                }
            });
        });

        // Individual activate buttons
        const activateButtons = document.querySelectorAll('.activate-slot');
        activateButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to activate this time slot?')) {
                    const slotId = this.dataset.slotId;
                    bulkAction.value = 'activate';
                    selectedSlotIds.value = slotId;
                    bulkActionForm.submit();
                }
            });
        });

        // Card click to toggle checkbox
        timeSlotCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Don't toggle if clicking on a button or link
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' ||
                    e.target.closest('button') || e.target.closest('a') ||
                    e.target.tagName === 'INPUT') {
                    return;
                }

                const slotId = this.dataset.slotId;
                const checkbox = document.querySelector(`.slot-checkbox[data-slot-id="${slotId}"]`);

                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('selected', checkbox.checked);
                    updateBulkActionButtons();
                }
            });
        });

        // Checkbox click
        slotCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation();
                const slotId = this.dataset.slotId;
                const card = document.querySelector(`.time-slot-card[data-slot-id="${slotId}"]`);
                card.classList.toggle('selected', this.checked);
                updateBulkActionButtons();
            });
        });

        // Select all button
        selectAllBtn.addEventListener('click', function() {
            slotCheckboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = true;
                    const slotId = checkbox.dataset.slotId;
                    const card = document.querySelector(`.time-slot-card[data-slot-id="${slotId}"]`);
                    card.classList.add('selected');
                }
            });
            updateBulkActionButtons();
        });

        // Deselect all button
        deselectAllBtn.addEventListener('click', function() {
            slotCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                const slotId = checkbox.dataset.slotId;
                const card = document.querySelector(`.time-slot-card[data-slot-id="${slotId}"]`);
                card.classList.remove('selected');
            });
            updateBulkActionButtons();
        });

        // Delete selected button
        deleteSelectedBtn.addEventListener('click', function() {
            const selectedIds = getSelectedSlotIds();
            if (selectedIds.length > 0) {
                if (confirm(`Are you sure you want to delete ${selectedIds.length} selected time slot(s)?`)) {
                    bulkAction.value = 'delete';
                    selectedSlotIds.value = selectedIds.join(',');
                    bulkActionForm.submit();
                }
            }
        });

        // Deactivate selected button
        deactivateSelectedBtn.addEventListener('click', function() {
            const selectedIds = getSelectedSlotIds();
            if (selectedIds.length > 0) {
                if (confirm(`Are you sure you want to deactivate ${selectedIds.length} selected time slot(s)?`)) {
                    bulkAction.value = 'deactivate';
                    selectedSlotIds.value = selectedIds.join(',');
                    bulkActionForm.submit();
                }
            }
        });

        // Activate selected button
        activateSelectedBtn.addEventListener('click', function() {
            const selectedIds = getSelectedSlotIds();
            if (selectedIds.length > 0) {
                if (confirm(`Are you sure you want to activate ${selectedIds.length} selected time slot(s)?`)) {
                    bulkAction.value = 'activate';
                    selectedSlotIds.value = selectedIds.join(',');
                    bulkActionForm.submit();
                }
            }
        });

        // Helper function to get selected slot IDs
        function getSelectedSlotIds() {
            const selectedIds = [];
            slotCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedIds.push(checkbox.dataset.slotId);
                }
            });
            return selectedIds;
        }

        // Update bulk action buttons based on selection
        function updateBulkActionButtons() {
            const selectedIds = getSelectedSlotIds();
            const hasSelection = selectedIds.length > 0;

            deleteSelectedBtn.disabled = !hasSelection;
            deactivateSelectedBtn.disabled = !hasSelection;
            activateSelectedBtn.disabled = !hasSelection;
        }
    });
</script>
{% endblock %}
