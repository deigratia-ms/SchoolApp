{% extends 'base.html' %}

{% block title %}Learning Materials | Ricas School Management System{% endblock %}

{% block extra_css %}
<style>
 /* General Styles */
 body {
  font-family: 'Nunito', sans-serif;
 }

 .container-fluid {
  padding: 20px;
 }

 .action-button {
  border-radius: 20px;
  padding: 8px 16px;
  font-weight: 600;
  transition: all 0.3s ease;
 }
 .action-button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
 }

 /* Card Styles */
.kid-friendly-card {
  border-radius: 15px;
  border: none;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease-in-out;
  background-color: #f8f9fa; /* Light background */
 }

 .kid-friendly-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
 }

 .kid-friendly-card .card-header {
  background: linear-gradient(135deg, #7b4397, #dc2430); /* Use a fun gradient */
  color: white;
  border-radius: 15px 15px 0 0;
  font-size: 1.2rem; /* Larger font size */
  font-weight: bold;
  padding: 15px 20px;
 }

 /* Filter and Search Styles */
 .filter-panel {
  border-radius: 15px;
  background-color: #f0f8ff; /* AliceBlue - soft and inviting */
  padding: 15px;
  margin-bottom: 20px;
 }

 .search-box {
  border-radius: 30px;
  padding-left: 20px;
  border: 2px solid #b19cd9; /* Light purple border */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
 }

 .search-box:focus {
  box-shadow: 0 0 10px rgba(123, 67, 151, 0.4); /* Deeper purple on focus */
  border-color: #7b4397;
 }

 /* List Item Styles */
 .list-group-item {
  background-color: #fff;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: background-color 0.3s ease;
 }

 .list-group-item:hover {
  background-color: #f0f8ff; /* AliceBlue on hover */
 }

 .list-group-item h5 {
  color: #7b4397; /* Deep purple for headings */
  font-weight: bold;
 }

 /* Badge Styles */
 .fun-badge {
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 0.9rem;
  font-weight: 600;
  margin-left: 10px;
 }

 /* Emoji and Icon Styles */
 .emoji-icon {
  font-size: 1.6rem; /* Larger emojis */
  margin-right: 10px;
  vertical-align: middle;
 }

 /* File Type Colors */
 .bg-danger { background-color: #ff6961; } /* Soft red */
 .bg-primary { background-color: #779ecb; } /* Soft blue */
 .bg-warning { background-color: #fdfd96; } /* Soft yellow */
 .bg-success { background-color: #77dd77; } /* Soft green */
 .bg-secondary { background-color: #c2b2d8; } /* Soft purple-gray */

 /* Empty State Styles */
 .empty-state-card {
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  background-color: #fff3cd; /* Pastel yellow */
  border: 2px dashed #ffda61;
 }

 .empty-state-card .emoji-icon {
  font-size: 4rem;
  margin-bottom: 20px;
 }

 /* Mobile Optimization */
 @media (max-width: 768px) {
  .filter-panel .form-label {
   margin-bottom: 0.2rem;
  }

  .filter-buttons {
   flex-direction: column;
   width: 100%;
  }

  .filter-buttons .btn {
   margin-bottom: 0.5rem;
   width: 100%;
  }

  .list-group-item {
   padding: 10px 15px;
  }
 }
 /* Increased Font Size */
 .form-select, .form-control, .btn, .list-group-item, h1, h3, h4, h5, h6, p, small, .badge {
  font-size: 1.1rem; /* Slightly larger font size for better readability */
 }

 /* View Mode Styles */
 .view-mode-selector {
    margin-bottom: 15px;
    text-align: right;
 }

 .view-mode-selector button {
    margin-left: 5px;
 }

 /* Card View Styles (Initially Hidden) */
 #materialsContainer.card-view {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px; /* Negative margin to offset the padding on items */
 }

 #materialsContainer.card-view .material-item {
    padding: 10px;
    display: flex;
 }

 #materialsContainer.card-view .material-item .card-view-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
 }

 #materialsContainer.card-view .material-item .card-body {
    flex: 1; /* Make the card body take up all available space */
 }

 /* Mobile-First Approach */
 @media (max-width: 575.98px) {
    #materialsContainer.card-view .material-item {
        width: 100%; /* One card per row on small screens */
    }
 }

 /* Medium Screens (e.g., Tablets) */
 @media (min-width: 576px) and (max-width: 991.98px) {
    #materialsContainer.card-view .material-item {
        width: 50%; /* Two cards per row */
    }
 }

 /* Large Screens (e.g., Desktops) */
 @media (min-width: 992px) and (max-width: 1199.98px) {
    #materialsContainer.card-view .material-item {
        width: 33.333%; /* Three cards per row */
    }
 }

 /* Extra Large Screens */
 @media (min-width: 1200px) {
    #materialsContainer.card-view .material-item {
        width: 25%; /* Four cards per row */
    }
 }

  /* List View Styles */
 #materialsContainer.list-view .material-item {
    width: 100%; /* Full width for list items */
 }

 @media (max-width: 768px) {
    .table-responsive {
        border: 0;
    }

    #materialsTable {
        border: 0;
    }

    #materialsTable thead {
        display: none;
    }

    #materialsTable tr {
        margin-bottom: 1rem;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #materialsTable td {
        display: block;
        text-align: right;
        padding: .5rem;
        border: none;
    }

    #materialsTable td:before {
        content: attr(data-label);
        float: left;
        font-weight: bold;
    }

    #materialsTable td:last-child {
        border-bottom: 0;
    }

    .btn-group {
        display: flex;
        justify-content: flex-end;
        width: 100%;
        gap: 5px;
    }

    .modal-dialog {
        margin: 0.5rem;
    }
 }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pb-4">
    {% if user.role == 'TEACHER' or user.role == 'ADMIN' %}
    <!-- Professional Teacher View -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Course Materials Management</h1>
        <a href="{% url 'courses:create_material' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Material
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Learning Materials</h6>
            <div class="d-flex">
                <!-- Search Bar -->
                <div class="input-group me-2" style="width: 300px;">
                    <input type="text" class="form-control" placeholder="Search materials..." id="materialSearch">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <!-- Filter Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="?type=all">All Types</a></li>
                        <li><a class="dropdown-item" href="?type=notes">Notes</a></li>
                        <li><a class="dropdown-item" href="?type=files">Files</a></li>
                        <li><a class="dropdown-item" href="?type=pdf">PDF Documents</a></li>
                        <li><a class="dropdown-item" href="?type=doc">Word Documents</a></li>
                        <li><a class="dropdown-item" href="?type=ppt">Presentations</a></li>
                        <li><a class="dropdown-item" href="?type=other">Other Files</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="materialsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Class</th>
                            <th>Uploaded</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in materials %}
                        <tr>
                            <td>
                                <a href="{% url 'courses:material_detail' material.id %}" class="text-primary">
                                    {{ material.title }}
                                    {% if material.is_draft %}
                                    <span class="badge bg-warning ms-2" data-bs-toggle="tooltip" title="This material is only visible to you and administrators">Draft</span>
                                    {% endif %}
                                </a>
                            </td>
                            <td>
                                {% if material.has_content %}<span class="badge bg-info me-1">Notes</span>{% endif %}
                                {% if material.has_file %}
                                    {% if material.file.name|lower|slice:"-3:" == 'pdf' %}
                                        <span class="badge bg-danger">PDF</span>
                                    {% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}
                                        <span class="badge bg-primary">Word</span>
                                    {% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}
                                        <span class="badge bg-warning">PowerPoint</span>
                                    {% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}
                                        <span class="badge bg-success">Image</span>
                                    {% else %}
                                        <span class="badge bg-secondary">File</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ material.class_subject.subject.name }}</td>
                            <td>{{ material.class_subject.classroom.name }}</td>
                            <td>{{ material.created_at|date:"M d, Y" }}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'courses:material_detail' material.id %}" class="btn btn-info btn-sm" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'courses:edit_material' material.id %}" class="btn btn-warning btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="confirmDelete({{ material.id }})"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% if material.has_file %}
                                    <a href="{{ material.file.url }}" class="btn btn-primary btn-sm" download title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Student/Parent View -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <span class="emoji-icon">üìö</span>Learning Materials
            </h1>
            {% if user.role == 'ADMIN' or user.role == 'TEACHER' %}
            <div class="mt-2">
                <a href="{% url 'courses:material_list' %}?draft=yes" class="btn btn-outline-warning btn-sm me-2">
                    <i class="fas fa-pencil-alt me-1"></i>My Drafts
                </a>
                <a href="{% url 'courses:material_list' %}?draft=no" class="btn btn-outline-success btn-sm me-2">
                    <i class="fas fa-check-circle me-1"></i>Published Materials
                </a>
                <a href="{% url 'courses:manage_materials' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-cog me-1"></i>Advanced Management
                </a>
            </div>
            {% endif %}
        </div>
        {% if user.role == 'ADMIN' or user.role == 'TEACHER' %}
        <div>
            <a href="{% url 'courses:manage_materials' %}" class="btn btn-outline-primary action-button me-2">
                <i class="fas fa-cog me-1"></i>Manage Materials
            </a>
            <a href="{% url 'courses:create_material' %}" class="btn btn-primary action-button">
                <i class="fas fa-plus-circle me-2"></i>Add New Material
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Search Bar and Filters Combined -->
    <div class="card kid-friendly-card shadow mb-4">
        <div class="card-body p-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-lg-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-0">
                            <span class="emoji-icon">üîç</span>
                        </span>
                        <input type="text" name="search" class="form-control search-box border-0 shadow-none"
                            placeholder="Find something to learn..." value="{{ search_term }}">
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="row g-3">
                        {% if user.role == 'ADMIN' or user.role == 'PARENT' %}
                        <div class="col-md-4">
                            <select class="form-select rounded-pill" name="class">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}" {% if class.id|stringformat:"s" == selected_class %}selected{% endif %}>{{ class.name }} {{ class.section }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="col-md-4">
                            <select class="form-select rounded-pill" name="subject">
                                <option value="">All Subjects</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if subject.id|stringformat:"s" == selected_subject %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <select class="form-select rounded-pill" name="type">
                                <option value="" {% if selected_type == '' %}selected{% endif %}>Everything</option>
                                <option value="notes" {% if selected_type == 'notes' %}selected{% endif %}>Notes</option>
                                <option value="files" {% if selected_type == 'files' %}selected{% endif %}>Files</option>
                                <option value="pdf" {% if selected_type == 'pdf' %}selected{% endif %}>PDF</option>
                                <option value="doc" {% if selected_type == 'doc' %}selected{% endif %}>Word</option>
                                <option value="ppt" {% if selected_type == 'ppt' %}selected{% endif %}>PowerPoint</option>
                                <option value="img" {% if selected_type == 'img' %}selected{% endif %}>Pictures</option>
                                <option value="other" {% if selected_type == 'other' %}selected{% endif %}>Other Stuff</option>
                            </select>
                        </div>

                        {% if user.role == 'ADMIN' or user.role == 'TEACHER' %}
                        <div class="col-md-4">
                            <select class="form-select rounded-pill" name="draft">
                                <option value="" {% if request.GET.draft == '' or not request.GET.draft %}selected{% endif %}>All Status</option>
                                <option value="yes" {% if request.GET.draft == 'yes' %}selected{% endif %}>Drafts Only</option>
                                <option value="no" {% if request.GET.draft == 'no' %}selected{% endif %}>Published Only</option>
                            </select>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-12 col-lg-3 d-flex align-items-end">
                    <div class="filter-buttons d-flex">
                        <button type="submit" class="btn btn-primary me-2 action-button">
                            <i class="fas fa-check me-1"></i>Use These Filters
                        </button>
                        <a href="{% url 'courses:material_list' %}" class="btn btn-outline-secondary action-button">
                            <i class="fas fa-redo me-1"></i>Start Over
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sorting and View Mode Dropdowns -->
    <div class="mb-3 d-flex justify-content-end align-items-center">
        <div class="dropdown me-2">
            <button class="btn btn-outline-secondary dropdown-toggle action-button" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-sort me-1"></i>Sort By
            </button>
            <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                <li><a class="dropdown-item" href="?sort=-created_at">Newest First</a></li>
                <li><a class="dropdown-item" href="?sort=created_at">Oldest First</a></li>
                <li><a class="dropdown-item" href="?sort=title">Title (A-Z)</a></li>
                <li><a class="dropdown-item" href="?sort=-title">Title (Z-A)</a></li>
            </ul>
        </div>
        <div class="btn-group view-mode-selector" role="group" aria-label="View Mode">
            <button type="button" class="btn btn-outline-primary" data-view="list"><i class="fas fa-list"></i> List</button>
            <button type="button" class="btn btn-outline-primary" data-view="card"><i class="fas fa-th"></i> Card</button>
        </div>
    </div>

    <!-- Materials List -->
    <div class="row">
        <div class="col-12">
            <div id="materialsContainer" class="mb-4">
            {% if materials %}
                {% for material in materials %}
                    <div class="material-item">
                        <!-- List View Item (Default) -->
                        <a href="{% url 'courses:material_detail' material.id %}" class="list-group-item list-group-item-action list-view-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 text-truncate">
                                    {{ material.title }}
                                    {% if material.is_draft %}
                                    <span class="badge bg-warning ms-2" data-bs-toggle="tooltip" title="This material is only visible to you and administrators">Draft</span>
                                    {% endif %}
                                </h5>
                                <small>
                                    {% if material.has_content %}
                                    <span class="badge bg-info fun-badge me-1">Notes</span>
                                    {% endif %}
                                    {% if material.has_file %}
                                        {% if material.file.name|lower|slice:"-3:" == 'pdf' %}
                                            <span class="badge bg-danger fun-badge">PDF</span>
                                        {% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}
                                            <span class="badge bg-primary fun-badge">Word</span>
                                        {% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}
                                            <span class="badge bg-warning fun-badge">Slides</span>
                                        {% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}
                                            <span class="badge bg-success fun-badge">Picture</span>
                                        {% else %}
                                            <span class="badge bg-secondary fun-badge">File</span>
                                        {% endif %}
                                    {% endif %}
                                </small>
                            </div>
                            <small class="text-muted">
                                {{ material.class_subject.subject.name }} | {{ material.class_subject.classroom.name }}
                                {% if material.class_subject.classroom.section %} ({{ material.class_subject.classroom.section }}){% endif %}
                            </small>
                        </a>

                        <!-- Card View Item (Initially Hidden) -->
                        <div class="card kid-friendly-card h-100 card-view-item" style="display: none;">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <div class="text-truncate me-2" title="{{ material.title }}">
                                    {{ material.title }}
                                    {% if material.is_draft %}
                                    <span class="badge bg-warning ms-2" data-bs-toggle="tooltip" title="This material is only visible to you and administrators">Draft</span>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if material.has_content %}
                                    <span class="badge bg-info me-1">Notes</span>
                                    {% endif %}
                                    {% if material.has_file %}
                                    <span class="badge {% if material.file.name|lower|slice:"-3:" == 'pdf' %}bg-danger{% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}bg-primary{% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}bg-warning{% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}bg-success{% else %}bg-secondary{% endif %} fun-badge">
                                        {% if material.file.name|lower|slice:"-3:" == 'pdf' %}
                                            PDF
                                        {% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}
                                            Word
                                        {% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}
                                            Slides
                                        {% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}
                                            Picture
                                        {% else %}
                                            File
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    {% if material.has_content and material.has_file %}
                                    <div class="d-flex justify-content-center">
                                        <i class="fas fa-file-alt material-icon mb-2 me-2"></i>
                                        <i class="fas {% if material.file.name|lower|slice:"-3:" == 'pdf' %}fa-file-pdf pdf-icon{% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}fa-file-word doc-icon{% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}fa-file-powerpoint ppt-icon{% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}fa-file-image img-icon{% else %}fa-file-alt{% endif %} material-icon mb-2"></i>
                                    </div>
                                    {% elif material.has_content %}
                                    <i class="fas fa-file-alt material-icon mb-2"></i>
                                    {% elif material.has_file %}
                                    <i class="fas {% if material.file.name|lower|slice:"-3:" == 'pdf' %}fa-file-pdf pdf-icon{% elif material.file.name|lower|slice:"-3:" == 'doc' or material.file.name|lower|slice:"-4:" == 'docx' %}fa-file-word doc-icon{% elif material.file.name|lower|slice:"-3:" == 'ppt' or material.file.name|lower|slice:"-4:" == 'pptx' %}fa-file-powerpoint ppt-icon{% elif material.file.name|lower|slice:"-3:" == 'jpg' or material.file.name|lower|slice:"-3:" == 'png' or material.file.name|lower|slice:"-3:" == 'gif' %}fa-file-image img-icon{% else %}fa-file-alt{% endif %} material-icon mb-2"></i>
                                    {% endif %}
                                </div>

                                <div class="d-flex justify-content-center mb-3">
                                    <span class="subject-tag">{{ material.class_subject.subject.name }}</span>
                                    <span class="class-tag">{{ material.class_subject.classroom.name }}</span>
                                </div>

                                <p class="material-description small text-center">
                                    {{ material.description|truncatechars:60|default:"Click to learn more!" }}
                                </p>
                            </div>
                            <div class="card-footer bg-transparent border-0 d-flex justify-content-center">
                                <a href="{% url 'courses:material_detail' material.id %}" class="btn btn-primary action-button me-2">
                                    <i class="fas fa-book-open me-1"></i>View
                                </a>

                                {% if material.has_file %}
                                <a href="{{ material.file.url }}" class="btn btn-success action-button" target="_blank">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card kid-friendly-card shadow empty-state-card">
                    <div class="card-body text-center py-5">
                        <div class="emoji-icon mb-3" style="font-size: 4rem;">üìö</div>
                        <h4 class="mb-3">No materials yet!</h4>
                        <p class="text-muted">There aren't any learning materials here right now.</p>
                        {% if user.role == 'ADMIN' or user.role == 'TEACHER' %}
                        <a href="{% url 'courses:create_material' %}" class="btn btn-primary btn-lg action-button mt-3">
                            <i class="fas fa-plus-circle me-2"></i>Add Your First Material
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal for delete confirmation -->
<div class="modal fade" id="deleteMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMaterialModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this material? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteMaterialForm" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Material Modal -->
<div class="modal fade" id="viewMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewMaterialModalLabel">View Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Preview message div -->
                <div id="previewMessage" class="alert alert-info d-none text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>This file type cannot be previewed directly. Please download to view.</span>
                </div>
                <!-- Preview iframe -->
                <div class="embed-responsive ratio ratio-16x9">
                    <iframe id="materialPreview" class="embed-responsive-item" style="width: 100%; min-height: 500px;"></iframe>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" id="detailsLink" class="btn btn-primary">View Details</a>
                <a href="#" id="downloadLink" class="btn btn-success" download>
                    <i class="fas fa-download me-1"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewButtons = document.querySelectorAll('.view-mode-selector button');
        const materialsContainer = document.getElementById('materialsContainer');
        const materialItems = materialsContainer.querySelectorAll('.material-item');


        function setViewMode(viewMode) {
            materialsContainer.classList.remove('list-view', 'card-view', 'detail-view');
            materialsContainer.classList.add(viewMode + '-view');

            materialItems.forEach(item => {
                item.querySelector('.list-view-item').style.display = viewMode === 'list' ? 'block' : 'none';
                item.querySelector('.card-view-item').style.display = viewMode === 'card' ? 'block' : 'none';
                // Add detail view logic here later
            });
        }

        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const viewMode = this.getAttribute('data-view');
                setViewMode(viewMode);

                // Store the selected view mode in localStorage
                localStorage.setItem('materialListViewMode', viewMode);

                // Update button active states
                viewButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });

      // Check for previously selected view mode in localStorage or get parameter
        const urlParams = new URLSearchParams(window.location.search);
        let savedViewMode = urlParams.get('view') || localStorage.getItem('materialListViewMode');

        if (!savedViewMode) {
          savedViewMode = 'list'
        }

        setViewMode(savedViewMode);
        document.querySelector(`.view-mode-selector button[data-view="${savedViewMode}"]`).classList.add('active');

    });

    // Function to update the URL with the selected view mode
    function updateURL(viewMode) {
        const url = new URL(window.location.href);
        url.searchParams.set('view', viewMode);
        window.history.replaceState({}, '', url);
    }

    $(document).ready(function() {
        $('#materialsTable').DataTable({
            "order": [[4, "desc"]] // Order by upload date by default
        });

        // Handle material preview in modal
        $('.view-material').click(function() {
            const materialUrl = $(this).data('material-url');
            const materialId = $(this).data('material-id');
            const materialTitle = $(this).data('material-title');

            // Update modal title
            $('#viewMaterialModalLabel').text(materialTitle);

            // Update iframe source
            $('#materialPreview').attr('src', materialUrl);

            // Update "View Details" button link
            $('#viewDetailsBtn').attr('href', `/courses/materials/${materialId}/`);
        });

        // Add data-label attributes for mobile view
        $('#materialsTable tbody tr').each(function() {
            $(this).find('td').each(function(index) {
                let headerText = $('#materialsTable thead th').eq(index).text();
                $(this).attr('data-label', headerText);
            });
        });
    });

    // Delete functionality
    function confirmDelete(materialId) {
        const form = document.getElementById('deleteMaterialForm');
        form.action = `/courses/materials/${materialId}/delete/`;
        $('#deleteMaterialModal').modal('show');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const deleteButtons = document.querySelectorAll('.delete-material-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                confirmDelete(this.dataset.materialId);
            });
        });
    });

    function viewMaterial(title, fileUrl, materialId) {
        // Update modal title
        document.querySelector('#viewMaterialModal .modal-title').textContent = title;

        // Get file extension and convert to lowercase
        const fileExt = fileUrl.split('.').pop().toLowerCase();

        // Get preview elements
        const previewMessage = document.getElementById('previewMessage');
        const previewFrame = document.getElementById('materialPreview');
        const downloadLink = document.getElementById('downloadLink');

        // Update download link
        downloadLink.href = fileUrl;

        // Handle different file types
        if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
            // Image files - direct preview
            previewMessage.classList.add('d-none');
            previewFrame.classList.remove('d-none');
            previewFrame.src = fileUrl;
        }
        else if (fileExt === 'pdf') {
            // PDF files - use browser's PDF viewer if possible
            previewMessage.classList.add('d-none');
            previewFrame.classList.remove('d-none');
            // Try using browser's PDF viewer first
            previewFrame.src = fileUrl;

            // Add error handler for PDF preview
            previewFrame.onerror = function() {
                // If browser can't display PDF, show message
                previewMessage.classList.remove('d-none');
                previewFrame.classList.add('d-none');
                previewMessage.querySelector('span').textContent =
                    'PDF preview is not available. Please download to view.';
            };
        }
        else {
            // Other file types - show appropriate message
            previewMessage.classList.remove('d-none');
            previewFrame.classList.add('d-none');
            previewFrame.src = '';

            // Customize message based on file type
            let fileTypeDisplay = fileExt.toUpperCase();
            switch(fileExt) {
                case 'doc':
                case 'docx':
                    fileTypeDisplay = 'Word Document';
                    break;
                case 'ppt':
                case 'pptx':
                    fileTypeDisplay = 'PowerPoint Presentation';
                    break;
                case 'xls':
                case 'xlsx':
                    fileTypeDisplay = 'Excel Spreadsheet';
                    break;
            }

            previewMessage.querySelector('span').textContent =
                `This file (${fileTypeDisplay}) cannot be previewed directly. Please download to view.`;
        }

        // Update details link
        document.getElementById('detailsLink').href = `/courses/materials/${materialId}/`;

        // Show modal
        new bootstrap.Modal(document.getElementById('viewMaterialModal')).show();
    }
</script>
{% endblock %}