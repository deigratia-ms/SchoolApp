{% extends 'base.html' %}

{% block title %}Create Event - Ricas School Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="row">
                        <div class="col-6">
                            <h5 class="mb-0">Create Event</h5>
                            <p class="text-sm mb-0">Add a new event to the school calendar</p>
                        </div>
                        <div class="col-6 text-end">
                            <a href="{% url 'communications:event_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Events
                            </a>
                            <a href="{% url 'communications:event_calendar' %}" class="btn btn-info">
                                <i class="fas fa-calendar-alt"></i> Calendar View
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Event Title -->
                        <div class="mb-4">
                            <label for="id_title" class="form-label">Event Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control {% if form.title.errors %}is-invalid{% endif %}"
                                   id="id_title" name="title" required
                                   value="{{ form.title.value|default:'' }}" maxlength="200">
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Enter a descriptive title for the event (max 200 characters)
                            </small>
                        </div>

                        <!-- Event Type & Target -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_event_type" class="form-label">Event Type <span class="text-danger">*</span></label>
                                <select class="form-select {% if form.event_type.errors %}is-invalid{% endif %}"
                                        id="id_event_type" name="event_type" required>
                                    <option value="">Select event type...</option>
                                    <option value="HOLIDAY" {% if form.event_type.value == 'HOLIDAY' %}selected{% endif %}>
                                        Holiday
                                    </option>
                                    <option value="MEETING" {% if form.event_type.value == 'MEETING' %}selected{% endif %}>
                                        Meeting
                                    </option>
                                    <option value="ACTIVITY" {% if form.event_type.value == 'ACTIVITY' %}selected{% endif %}>
                                        Activity
                                    </option>
                                    <option value="EXAM" {% if form.event_type.value == 'EXAM' %}selected{% endif %}>
                                        Exam
                                    </option>
                                    <option value="OTHER" {% if form.event_type.value == 'OTHER' %}selected{% endif %}>
                                        Other
                                    </option>
                                </select>
                                {% if form.event_type.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.event_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="id_target_type" class="form-label">Target Audience <span class="text-danger">*</span></label>
                                <select class="form-select {% if form.target_type.errors %}is-invalid{% endif %}"
                                        id="id_target_type" name="target_type" required>
                                    <option value="">Select audience...</option>
                                    <option value="ALL" {% if form.target_type.value == 'ALL' %}selected{% endif %}>
                                        Everyone
                                    </option>
                                    <option value="TEACHERS" {% if form.target_type.value == 'TEACHERS' %}selected{% endif %}>
                                        All Teachers
                                    </option>
                                    <option value="STUDENTS" {% if form.target_type.value == 'STUDENTS' %}selected{% endif %}>
                                        All Students
                                    </option>
                                    <option value="PARENTS" {% if form.target_type.value == 'PARENTS' %}selected{% endif %}>
                                        All Parents
                                    </option>
                                    <option value="SPECIFIC_CLASS" {% if form.target_type.value == 'SPECIFIC_CLASS' %}selected{% endif %}>
                                        Specific Class
                                    </option>
                                </select>
                                {% if form.target_type.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.target_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- School-Wide Event Setting -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="id_is_school_wide" name="is_school_wide"
                                  {% if form.is_school_wide.value %}checked{% endif %} checked>
                            <label class="form-check-label" for="id_is_school_wide">
                                <strong>Is school wide</strong> - Make this event visible to all users regardless of target audience
                            </label>
                            {% if form.is_school_wide.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.is_school_wide.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                If checked, this event will appear on all users' dashboards and calendars. If unchecked, it will only be visible to the selected target audience.
                            </small>
                        </div>

                        <!-- Specific Class -->
                        <div id="class_selection" class="mb-4" style="display: none;">
                            <label for="id_target_class" class="form-label">Select Class <span class="text-danger">*</span></label>
                            <select class="form-select {% if form.target_class.errors %}is-invalid{% endif %}"
                                    id="id_target_class" name="target_class">
                                <option value="">Select a class...</option>
                                {% for class in classes %}
                                    <option value="{{ class.id }}" {% if form.target_class.value == class.id|stringformat:"s" %}selected{% endif %}>
                                        {{ class.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.target_class.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.target_class.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Date & Time Settings -->
                        <div class="card bg-light mb-4">
                            <div class="card-header bg-light pb-0">
                                <h6 class="mb-0">Date & Time Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="id_start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control {% if form.start_date.errors %}is-invalid{% endif %}"
                                               id="id_start_date" name="start_date" required
                                               value="{{ form.start_date.value|date:'Y-m-d'|default:'' }}">
                                        {% if form.start_date.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.start_date.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_end_date" class="form-label">End Date</label>
                                        <input type="date" class="form-control {% if form.end_date.errors %}is-invalid{% endif %}"
                                               id="id_end_date" name="end_date"
                                               value="{{ form.end_date.value|date:'Y-m-d'|default:'' }}">
                                        {% if form.end_date.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.end_date.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            Optional. Leave blank for single-day events.
                                        </small>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="id_all_day" name="all_day"
                                           {% if form.all_day.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_all_day">
                                        All-day event
                                    </label>
                                    {% if form.all_day.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.all_day.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div id="time_fields" class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="id_start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control {% if form.start_time.errors %}is-invalid{% endif %}"
                                               id="id_start_time" name="start_time"
                                               value="{{ form.start_time.value|time:'H:i'|default:'' }}">
                                        {% if form.start_time.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.start_time.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="id_end_time" class="form-label">End Time</label>
                                        <input type="time" class="form-control {% if form.end_time.errors %}is-invalid{% endif %}"
                                               id="id_end_time" name="end_time"
                                               value="{{ form.end_time.value|time:'H:i'|default:'' }}">
                                        {% if form.end_time.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.end_time.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            Optional. Leave blank if not applicable.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Settings -->
                        <div class="card bg-light mb-4">
                            <div class="card-header bg-light pb-0">
                                <h6 class="mb-0">Location Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="id_location" class="form-label">Location</label>
                                    <input type="text" class="form-control {% if form.location.errors %}is-invalid{% endif %}"
                                           id="id_location" name="location"
                                           value="{{ form.location.value|default:'' }}">
                                    {% if form.location.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.location.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Physical location of the event (e.g., "Main Auditorium", "Sports Field").
                                    </small>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="id_is_virtual" name="is_virtual"
                                           {% if form.is_virtual.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_is_virtual">
                                        Virtual event (online)
                                    </label>
                                    {% if form.is_virtual.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.is_virtual.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div id="virtual_link_field" class="mb-3" style="display: none;">
                                    <label for="id_meeting_link" class="form-label">Meeting Link</label>
                                    <input type="url" class="form-control {% if form.meeting_link.errors %}is-invalid{% endif %}"
                                           id="id_meeting_link" name="meeting_link"
                                           value="{{ form.meeting_link.value|default:'' }}"
                                           placeholder="https://...">
                                    {% if form.meeting_link.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.meeting_link.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        URL for virtual meeting (Zoom, Google Meet, etc.)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Event Description -->
                        <div class="mb-4">
                            <label for="id_description" class="form-label">Description</label>
                            <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                                      id="id_description" name="description" rows="5">{{ form.description.value|default:'' }}</textarea>
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Provide details about the event (agenda, what to bring, etc.)
                            </small>
                        </div>

                        <!-- Additional Settings -->
                        <div class="card bg-light mb-4">
                            <div class="card-header bg-light pb-0">
                                <h6 class="mb-0">Website Integration</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="id_show_on_website" name="show_on_website" {% if form.show_on_website.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_show_on_website">
                                        Show this event on the public website
                                    </label>
                                    <div class="form-text">
                                        If checked, this event will be displayed on the public website events page.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="id_attachment" class="form-label">Attachment / Image</label>
                                    <input type="file" class="form-control {% if form.attachment.errors %}is-invalid{% endif %}"
                                           id="id_attachment" name="attachment">
                                    {% if form.attachment.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.attachment.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Max file size: 10MB. Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG<br>
                                        <strong>Note:</strong> If the event is shown on the website, this attachment will be used as the event image.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="history.back()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calendar-plus"></i> Create Event
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const targetTypeSelect = document.getElementById('id_target_type');
        const classSelection = document.getElementById('class_selection');
        const isAllDayCheckbox = document.getElementById('id_all_day');
        const timeFields = document.getElementById('time_fields');
        const isVirtualCheckbox = document.getElementById('id_is_virtual');
        const virtualLinkField = document.getElementById('virtual_link_field');

        // Target audience selection
        function updateTargetFields() {
            if (targetTypeSelect.value === 'SPECIFIC_CLASS') {
                classSelection.style.display = 'block';
            } else {
                classSelection.style.display = 'none';
            }
        }

        // All-day event toggle
        function updateTimeFields() {
            if (isAllDayCheckbox.checked) {
                timeFields.style.display = 'none';
            } else {
                timeFields.style.display = 'flex';
            }
        }

        // Virtual event toggle
        function updateVirtualFields() {
            if (isVirtualCheckbox.checked) {
                virtualLinkField.style.display = 'block';
            } else {
                virtualLinkField.style.display = 'none';
            }
        }

        // Initial state
        updateTargetFields();
        updateTimeFields();
        updateVirtualFields();

        // Update on change
        targetTypeSelect.addEventListener('change', updateTargetFields);
        isAllDayCheckbox.addEventListener('change', updateTimeFields);
        isVirtualCheckbox.addEventListener('change', updateVirtualFields);

        // End date validation
        const startDateInput = document.getElementById('id_start_date');
        const endDateInput = document.getElementById('id_end_date');

        endDateInput.addEventListener('change', function() {
            if (endDateInput.value && startDateInput.value && endDateInput.value < startDateInput.value) {
                alert('End date cannot be before start date');
                endDateInput.value = startDateInput.value;
            }
        });

        startDateInput.addEventListener('change', function() {
            if (endDateInput.value && startDateInput.value && endDateInput.value < startDateInput.value) {
                endDateInput.value = startDateInput.value;
            }
        });
    });
</script>
{% endblock %}
{% endblock %}